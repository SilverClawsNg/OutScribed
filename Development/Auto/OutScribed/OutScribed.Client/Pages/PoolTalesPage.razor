@page "/pool/tales"

@inject NavigationManager navigator
@inject IApiGetServices<AllTaleDraftsResponse> getTales
@inject IAuthenticationServices authenticate
@inject ISelectServices getSelect
@inject IApiGetServices<UserProfileResponse> getProfile
@inject ILocalStorageService localStorage
@inject IJSRuntime JsRuntime

@if (Info != null)
{
    <div id="quick-info">@Info</div>
}

<div id="modal" class="@(IsModalOpen ? "active" : null)">

    <a href="#" class="close-modal-wrapper" @onclick:preventDefault="true" @onclick='() => CloseModal()'></a>

    <div class="@(IsExpandModal ? $"inner-modal expand" : $"inner-modal")">

        @if (Components != null && Components.Any())
        {
            @foreach (var component in Components.OrderBy(c=>c.Date))
            {

                <div @key="component" class="@(component == Components.First() ? $"modal-contents first {component.ComponentClass}" : $"modal-contents {component.ComponentClass}")">

                    @if (component.ComponentType == ComponentTypes.TaleHistory)
                    {
                        if (component.HasContents)
                        {

                            <TaleHistoryComponent Component="component"
                            OnExpandModal="ExpandModal"
                            OnRemoveComponent="RemoveComponent"
                            OnAddComponent="AddComponent" />
                        }

                    }
                    else if (component.ComponentType == ComponentTypes.UpdateTaleBasic)
                    {
                        if (component.HasContents)
                        {

                            <UpdateTaleBasicForm Component="component"
                            OnExpandModal="ExpandModal"
                            OnRemoveComponent="RemoveComponent"
                            OnAddComponent="AddComponent" />
                        }

                    }
                    else if (component.ComponentType == ComponentTypes.UpdateTaleSummary)
                    {
                        if (component.HasContents)
                        {

                            <UpdateTaleSummaryForm Component="component"
                            OnExpandModal="ExpandModal"
                            OnRemoveComponent="RemoveComponent"
                            OnAddComponent="AddComponent" />
                        }

                    }
                    else if (component.ComponentType == ComponentTypes.UpdateTalePhoto)
                    {
                        if (component.HasContents)
                        {

                            <UpdateTalePhotoForm Component="component"
                            OnExpandModal="ExpandModal"
                            OnRemoveComponent="RemoveComponent"
                            OnAddComponent="AddComponent" />
                        }

                    }
                    else if (component.ComponentType == ComponentTypes.UpdateTaleDetails)
                    {
                        if (component.HasContents)
                        {

                            <UpdateTaleDetailsForm Component="component"
                            OnExpandModal="ExpandModal"
                            OnRemoveComponent="RemoveComponent"
                            OnAddComponent="AddComponent" />
                        }

                    }
                    else if (component.ComponentType == ComponentTypes.PreviewTale)
                    {
                        if (component.HasContents)
                        {

                            <PreviewTaleComponent Component="component"
                            OnExpandModal="ExpandModal"
                            OnRemoveComponent="RemoveComponent"
                            OnAddComponent="AddComponent" />
                        }


                    }
                    else if (component.ComponentType == ComponentTypes.UpdateTaleStatus)
                    {
                        if (component.HasContents)
                        {

                            <UpdateTaleStatusForm Component="component"
                            OnExpandModal="ExpandModal"
                            OnRemoveComponent="RemoveComponent" />
                        }


                    }
                    else if (component.ComponentType == ComponentTypes.UserProfile)
                    {
                        if (component.HasContents)
                        {

                            <UserProfileComponent Component="component"
                            OnExpandModal="ExpandModal"
                            OnSetInfo="SetInfo"
                            OnAddComponent="AddComponent"
                            OnRemoveComponent="RemoveComponent" />

                        }

                    }
                    else if (component.ComponentType == ComponentTypes.LoginUser)
                    {
                        if (component.HasContents)
                        {

                            <LoginUserForm Component="component"
                            OnRemoveComponent="RemoveComponent"
                            OnExpandModal="ExpandModal" />
                        }

                    }

                </div>

            }
        }


    </div>

</div>

<HeaderComponent Tab="@NavTabs.None" />

<NavigationComponent Tab="@NavTabs.Pool_Tales" @ref="Navigation" />

<main>

    @if (InputError == null)
    {

        if (HasInput)
        {

            <div class="filter-container">

                <div class="filter-header alt">

                    <p>
                        @Input.CounterToString
                    </p>

                    <div class="filter-links">

                        <a href="#" class="filter" @onclick:preventDefault="true" @onclick='() => IsShowFilter = !IsShowFilter'>
                            Filter
                        </a>

                    </div>

                </div>

            </div>

            <div class="@(IsShowFilter ? "filter-contents active" : "filter-contents")">

                <div class="form-container alt">

                    <fieldset>

                        <select class="form-field" @onchange="@StatusClicked">

                            <option value="-1"></option>

                            @foreach (var status in Statuses)
                            {
                                if (Status != null && status.Value == int.Parse(Status))
                                {
                                    <option value="@status.Value" selected="selected">@status.Text</option>
                                }
                                else
                                {
                                    <option value="@status.Value">@status.Text</option>
                                }
                            }

                        </select>

                        <label class="@(string.IsNullOrEmpty(Status) || Status == "-1" ? null : "stay")">Filter by Status</label>

                    </fieldset>

                    <fieldset>

                        <select class="form-field" @onchange="@CategoryClicked">

                            <option value="-1"></option>

                            @foreach (var category in Categories)
                            {
                                if (Category != null && category.Value == int.Parse(Category))
                                {
                                    <option value="@category.Value" selected="selected">@category.Text</option>
                                }
                                else
                                {
                                    <option value="@category.Value">@category.Text</option>
                                }
                            }

                        </select>

                        <label class="@(string.IsNullOrEmpty(Category) || Category == "-1" ? null : "stay")">Filter by Category</label>

                    </fieldset>

                    <fieldset>

                        <select class="form-field" @onchange="@CountryClicked">

                            <option value="-1"></option>

                            @foreach (var country in Countries)
                            {
                                if (Country != null && country.Value == int.Parse(Country))
                                {
                                    <option value="@country.Value" selected="selected">@country.Text</option>
                                }
                                else
                                {
                                    <option value="@country.Value">@country.Text</option>
                                }
                            }

                        </select>

                        <label class="@(string.IsNullOrEmpty(Country) || Country == "-1" ? null : "stay")">Filter by Country</label>

                    </fieldset>

                    <fieldset class="username">

                        <InputText @bind-Value=@Username id="Username" class="form-field" />

                        <label class="@(string.IsNullOrEmpty(Username) ? null : "stay")">Filter by Username</label>

                    </fieldset>

                    <fieldset>

                        <InputText @bind-Value=@Keyword id="Keyword" class="form-field" />

                        <label class="@(string.IsNullOrEmpty(Keyword) ? null : "stay")">Filter by Keyword</label>

                    </fieldset>

                    <fieldset>

                        <select class="form-field" @onchange="@SortClicked">

                            <option value="-1"></option>

                            @foreach (var sort in Sorts)
                            {
                                if (Sort != null && sort.Value == int.Parse(Sort))
                                {
                                    <option value="@sort.Value" selected="selected">@sort.Text</option>
                                }
                                else
                                {
                                    <option value="@sort.Value">@sort.Text</option>
                                }
                            }

                        </select>

                        <label class="@(string.IsNullOrEmpty(Sort) || Sort == "-1" ? null : "stay")">Order Results</label>

                    </fieldset>

                    <div class="button-holder">

                        <button @onclick:preventDefault="true" @onclick='() => LoadInput()'>
                            Get Tales
                        </button>

                    </div>

                </div>

            </div>

            @if (Input.Tales != null && Input.Tales.Count > 0)
            {

                <div class="brief-content-container">

                    @foreach (var tale in Input.Tales)
                    {
                        <article class="brief-content">

                            <p class="content-subheading">
                                @tale.CategoryToString<span class="divider">|</span>
                                @if (tale.CountryToString != null)
                                {

                                    @tale.CountryToString
                                    <span class="divider">|</span>
                                }
                                @tale.DateToString
                            </p>

                            <h1 class="content-heading">
                                @tale.Title
                                <a class="at" href="#" @onclick:preventDefault="true" @onclick='() => AddComponent(new ComponentParameters()
                                                    { ComponentType = ComponentTypes.UserProfile, Id = tale.WriterId})'>
                                    @tale.WriterUsername
                                </a>
                            </h1>

                            <p class="content-summary">
                                @tale.Summary
                            </p>

                            <p class="content-summary italics">
                                @tale.StatusToString
                            </p>

                            <div class="content-links">

                                @if ((tale.Status == TaleStatuses.Submitted
                              || tale.Status == TaleStatuses.ReChecked
                              || tale.Status == TaleStatuses.OutChecked)
                              && (Role == RoleTypes.Checker || Role == RoleTypes.Publisher))
                                {
                                    <a href="#" @onclick:preventDefault="true" @onclick='() => AddComponent(new ComponentParameters()
                                                    { ComponentType = ComponentTypes.PreviewTale, TaleDraft = tale})'>
                                        Preview
                                    </a>
                                    <a href="#" @onclick:preventDefault="true" @onclick='() => AddComponent(new ComponentParameters()
                                                    { ComponentType = ComponentTypes.TaleHistory, TaleHistory = tale.History})'>
                                        History
                                    </a>
                                    <a href="#" @onclick:preventDefault="true" @onclick='() => AddComponent(new ComponentParameters()
                                                    { ComponentType = ComponentTypes.UpdateTaleStatus, TaleDraft = tale})'>
                                        Check
                                    </a>
                                }
                                else if ((tale.Status == TaleStatuses.Checked
                                || tale.Status == TaleStatuses.ReEdited
                                || tale.Status == TaleStatuses.OutEdited)
                                && (Role == RoleTypes.Editor || Role == RoleTypes.Publisher))
                                {
                                    <a href="#" @onclick:preventDefault="true" @onclick='() => AddComponent(new ComponentParameters()
                                                    { ComponentType = ComponentTypes.UpdateTaleBasic, TaleDraft = tale})'>
                                        Basic
                                    </a>
                                    <a href="#" @onclick:preventDefault="true" @onclick='() => AddComponent(new ComponentParameters()
                                                    { ComponentType = ComponentTypes.UpdateTaleSummary, TaleDraft = tale})'>
                                        Summary
                                    </a>
                                    <a href="#" @onclick:preventDefault="true" @onclick='() => AddComponent(new ComponentParameters()
                                                    { ComponentType = ComponentTypes.UpdateTaleCountry, TaleDraft = tale})'>
                                        Country
                                    </a>
                                    <a href="#" @onclick:preventDefault="true" @onclick='() => AddComponent(new ComponentParameters()
                                                    { ComponentType = ComponentTypes.UpdateTalePhoto, TaleDraft = tale})'>
                                        Photo
                                    </a>
                                    <a href="#" @onclick:preventDefault="true" @onclick='() => AddComponent(new ComponentParameters()
                                                    { ComponentType = ComponentTypes.UpdateTaleDetails, TaleDraft = tale})'>
                                        Details
                                    </a>
                                    <a href="#" @onclick:preventDefault="true" @onclick='() => AddComponent(new ComponentParameters()
                                                    { ComponentType = ComponentTypes.UpdateTaleTags, TaleDraft = tale})'>
                                        Tags
                                    </a>
                                    <a href="#" @onclick:preventDefault="true" @onclick='() => AddComponent(new ComponentParameters()
                                                    { ComponentType = ComponentTypes.PreviewTale, TaleDraft = tale})'>
                                        Preview
                                    </a>
                                    <a href="#" @onclick:preventDefault="true" @onclick='() => AddComponent(new ComponentParameters()
                                                    { ComponentType = ComponentTypes.TaleHistory, TaleHistory = tale.History})'>
                                        History
                                    </a>
                                    <a href="#" @onclick:preventDefault="true" @onclick='() => AddComponent(new ComponentParameters()
                                                    { ComponentType = ComponentTypes.UpdateTaleStatus, TaleDraft = tale})'>
                                        Edit
                                    </a>
                                }
                                else if ((tale.Status == TaleStatuses.Edited
                                || tale.Status == TaleStatuses.RePublished
                                || tale.Status == TaleStatuses.OutPublished)
                                && Role == RoleTypes.Publisher)
                                {
                                    <a href="#" @onclick:preventDefault="true" @onclick='() => AddComponent(new ComponentParameters()
                                                    { ComponentType = ComponentTypes.UpdateTaleBasic, TaleDraft = tale})'>
                                        Basic
                                    </a>
                                    <a href="#" @onclick:preventDefault="true" @onclick='() => AddComponent(new ComponentParameters()
                                                    { ComponentType = ComponentTypes.UpdateTaleSummary, TaleDraft = tale})'>
                                        Summary
                                    </a>
                                    <a href="#" @onclick:preventDefault="true" @onclick='() => AddComponent(new ComponentParameters()
                                                    { ComponentType = ComponentTypes.UpdateTalePhoto, TaleDraft = tale})'>
                                        Photo
                                    </a>
                                    <a href="#" @onclick:preventDefault="true" @onclick='() => AddComponent(new ComponentParameters()
                                                    { ComponentType = ComponentTypes.UpdateTaleDetails, TaleDraft = tale})'>
                                        Details
                                    </a>
                                    <a href="#" @onclick:preventDefault="true" @onclick='() => AddComponent(new ComponentParameters()
                                                    { ComponentType = ComponentTypes.PreviewTale, TaleDraft = tale})'>
                                        Preview
                                    </a>
                                    <a href="#" @onclick:preventDefault="true" @onclick='() => AddComponent(new ComponentParameters()
                                                    { ComponentType = ComponentTypes.TaleHistory, TaleHistory = tale.History})'>
                                        History
                                    </a>
                                    <a href="#" @onclick:preventDefault="true" @onclick='() => AddComponent(new ComponentParameters()
                                                    { ComponentType = ComponentTypes.UpdateTaleStatus, TaleDraft = tale})'>
                                        Publish
                                    </a>
                                }
                                else
                                {
                                    <a href="#" @onclick:preventDefault="true" @onclick='() => AddComponent(new ComponentParameters()
                                                    { ComponentType = ComponentTypes.PreviewTale, TaleDraft = tale})'>
                                        Preview
                                    </a>
                                }

                            </div>

                        </article>
                    }

                </div>

                <div class="navigation-container">

                    <div class="navigation-links">

                        @if (Input.Previous)
                        {
                            <a href="#" class="previous" @onclick:preventDefault="true" @onclick='() => LoadMore(0)'></a>
                        }
                        else
                        {
                            <a href="#" class="previous disabled" @onclick:preventDefault="true"></a>
                        }
                        @if (Input.Next)
                        {
                            <a href="#" class="next" @onclick:preventDefault="true" @onclick='() => LoadMore(1)'> </a>
                        }
                        else
                        {
                            <a href="#" class="next disabled" @onclick:preventDefault="true"> </a>
                        }

                    </div>

                </div>

            }
            else
            {
                <div class="no-content">

                    <ErrorGif />

                    <h3>
                        No Result!
                    </h3>

                    @if (Input.Keyword != null)
                    {
                        <p>
                            It appears no tale matches your keywords.
                        </p>
                        <p>
                            Try searching again with more specific keywords. Note that we do not search common words
                            like "is", "are", "them", etc.
                        </p>

                    }
                    else
                    {
                        <p>
                            No tale was found.

                        </p>

                    }

                </div>

            }

        }
        else
        {
            <LoadingComponent Type="--- loading pool tales ---" />

        }
    }
    else
    {
        <ErrorComponent Message=@InputError Type="pool tales" />
    }


</main>

<FooterComponent />

@code {

    [Parameter]
    public NavigationComponent Navigation { get; set; } = default!;

    bool IsModalOpen { get; set; } = false;

    bool IsShowFilter { get; set; } = false;

    List<DropdownList> Categories = new();

    List<DropdownList> Countries = new();

    List<DropdownList> Sorts = new();

    List<DropdownList> Statuses = new();


    string? Username { get; set; } = null;

    string? Status { get; set; }

    string? Category { get; set; }

    string? Country { get; set; }

    string? Sort { get; set; }

    private string? Keyword { get; set; }

    RoleTypes? Role { get; set; } = RoleTypes.None;


    public AllTaleDraftsResponse Input { get; set; } = default!;


    protected void CategoryClicked(ChangeEventArgs e)
    {
        Category = e.Value == null ? null : e.Value.ToString();
    }

    protected void CountryClicked(ChangeEventArgs e)
    {
        Country = e.Value == null ? null : e.Value.ToString();
    }

    protected void SortClicked(ChangeEventArgs e)
    {
        Sort = e.Value == null ? null : e.Value.ToString();
    }

    protected void StatusClicked(ChangeEventArgs e)
    {
        Status = e.Value == null ? null : e.Value.ToString();
    }


    protected override async Task OnInitializedAsync()
    {

        if (RendererInfo.Name == "Static")
        {
            return;
        }
        else if (RendererInfo.Name == "Server")
        {
            navigator.NavigateTo($"/login?returnUrl=/pool/tales", true);
        }

        Components = new();

        var starterData = await localStorage.GetItemAsync<StarterData>("starterData");

        if (starterData == null || starterData.Role == RoleTypes.None)
        {
            navigator.NavigateTo($"/login?returnUrl=/pool/tales", false);
        }
        else
        {
            Role = starterData.Role;

        }

        Countries = getSelect.Get<Countries>();

        Categories = getSelect.Get<Categories>();

        Sorts = getSelect.Get<SortTypes>();

        Statuses = getSelect.Get<TaleStatuses>();

        await LoadInput();

    }

    bool HasInput { get; set; } = false;

    private string? InputError { get; set; }


    public string? Info { get; set; }

    private async Task SetInfo(string info)
    {

        Info = info;

        StateHasChanged();

        await Task.Delay(5000);

        Info = null;

        StateHasChanged();

    }


    public async Task LoadMore(int type)
    {
        if (type == 0)
            Input.Pointer--;
        else if (type == 1)
            Input.Pointer++;

        if (Input.Pointer >= 0)
        {
            await LoadInput();
        }

    }

    public async Task LoadInput()
    {


        if (!await authenticate.CheckJwtTokenAsync())
        {
            navigator.NavigateTo($"/login?returnUrl=/pool/tales", false);
        }

        await JsRuntime.InvokeVoidAsync("OnScrollToTop");

        IsShowFilter = false;

        HasInput = false;

        InputError = null;


        var url = "tales/drafts/all?";

        if (!string.IsNullOrEmpty(Status) && Status != "-1")
        {
            Enum.TryParse(Status, out TaleStatuses status);

            url = url + $"status={status}&";
        }

        if (!string.IsNullOrEmpty(Country) && Country != "-1")
        {
            Enum.TryParse(Country, out Countries country);

            url = url + $"country={country}&";
        }

        if (!string.IsNullOrEmpty(Category) && Category != "-1")
        {
            Enum.TryParse(Category, out Categories category);

            url = url + $"category={category}&";
        }

        if (!string.IsNullOrEmpty(Sort) && Sort != "-1")
        {
            Enum.TryParse(Sort, out SortTypes sort);

            url = url + $"sort={sort}&";
        }

        if (!string.IsNullOrEmpty(Username))
        {
            url = url + $"username={Username}&";
        }

        if (!string.IsNullOrEmpty(Keyword))
        {
            url = url + $"keyword={Keyword}&";
        }

        if (Input != null && Input.Pointer > 0)
        {
            url = url + $"pointer={Input.Pointer}&size=5";
        }
        else
        {
            url = url + "size=6";
        }

        var result = await getTales.GetAsync(url, CancelToken);

        if (result.IsFailure)
        {
            InputError = result.Error ?? "Unknown server error";
        }
        else
        {
            Input = result.Value;
        }

        HasInput = true;

    }


    bool IsExpandModal { get; set; } = false;

    int ScrollPosition { get; set; }

    List<ComponentParameters> Components { get; set; } = default!;

    private async Task AddComponent(ComponentParameters component)
    {

        shouldRender = false;

        Components.Insert(0, component);

        if (!IsModalOpen)
        {
            IsModalOpen = true;

            await JsRuntime.InvokeVoidAsync("OnModalOpen");
        }

        await authenticate.CheckJwtTokenAsync();

        if (component.ComponentType == ComponentTypes.UserProfile)
        {
            var result = await getProfile.GetAsync($"users/profile/{component.Id}", CancelToken);

            if (result.IsFailure)
            {
                component.ErrorMessage = result.Error ?? "Unknown server error";

            }
            else
            {
                component.Profile = result.Value;
            }
        }

        component.HasContents = true;

        component.ComponentState = ComponentStates.Enter;

        shouldRender = true;

    }

    public async Task RemoveComponent(ComponentParameters component)
    {

        var info = component.Info;

        component.ComponentState = ComponentStates.Leave;

        if (info != null)
        {
            if (component.ComponentType == ComponentTypes.LoginUser)
            {
                await Navigation.Refresh();
            }
        }

        await Task.Delay(1000);

        Components.Remove(component);

        if (Components.Count == 0)
        {
            await CloseModal();
        }

        StateHasChanged();

        if (info != null)
            await SetInfo(info);
    }

    public void ExpandModal()
    {

        IsExpandModal = !IsExpandModal;

    }

    private bool shouldRender = true;

    protected override bool ShouldRender()
    {
        return shouldRender;
    }

    public async Task CloseModal()
    {

        Components = new();

        IsModalOpen = false;

        await JsRuntime.InvokeVoidAsync("OnModalClose");

        // StateHasChanged();

    }

}
