@inject IAuthenticationServices authenticate
@inject IApiPatchServices<CountsResponse,RateTaleCommentRequest> rateComment
@inject NavigationManager navigator

<div class="modal-header">

    <div class="inner-modal-header">

        <h1>
            <a class="close" href="#" @onclick:preventDefault="true" @onclick='(() => CloseModal())'>
                Tale
            </a>
        </h1>

        <div class="modal-header-menu">

            <a class="comment" href="#" @onclick:preventDefault="true" @onclick='() => AddComponent(new ComponentParameters()
                                                    { ComponentType = ComponentTypes.CreateTaleComment, Id = Component.TaleComments.TaleId})'>
            </a>
            <a class="@(Window ? "maximize" : "minimize")" href="#" @onclick:preventDefault="true" @onclick='(() => ExpandModal())'></a>
            <a class="close" href="#" @onclick:preventDefault="true" @onclick='(() => RemoveComponent())'>X</a>

        </div>

    </div>

</div>

@if(Component.ErrorMessage == null)
{

    <div class="modal-body">

        <div class="inner-modal-body">

            <div class="filter-container">

                <div class="filter-header alt">

                    <p>
                        @Component.TaleComments.CounterToString
                    </p>

                    <div class="filter-links">
                        <a href="#" class="filter" @onclick:preventDefault="true" @onclick='() => IsShowFilter = !IsShowFilter'>
                            Filter
                        </a>
                    </div>

                </div>

            </div>

            <div class="@(IsShowFilter ? "filter-contents active" : "filter-contents")">

                <div class="form-container alt">

                    <fieldset class="username">

                        <InputText @bind-Value=@Username id="Username" class="form-field" />

                        <label class="@(string.IsNullOrEmpty(Username) ? null : "stay")">Filter by Username</label>

                    </fieldset>

                    <fieldset>

                        <InputText @bind-Value=@Keyword id="Keyword" class="form-field" />

                        <label class="@(string.IsNullOrEmpty(Keyword) ? null : "stay")">Filter by Keyword</label>

                    </fieldset>

                    <fieldset>

                        <select class="form-field" @onchange="@SortClicked">

                            <option value="-1"></option>

                            <option value="@SortTypes.Most_Recent" selected="@(Sort == SortTypes.Most_Recent.ToString() ? "selected" : null)">Most Recent</option>

                            <option value="@SortTypes.Least_Recent" selected="@(Sort == SortTypes.Least_Recent.ToString() ? "selected" : null)">Least Recent</option>

                            <option value="@SortTypes.Most_Liked" selected="@(Sort == SortTypes.Most_Liked.ToString() ? "selected" : null)">Most Liked</option>

                            <option value="@SortTypes.Least_Liked" selected="@(Sort == SortTypes.Least_Liked.ToString() ? "selected" : null)">Least Liked</option>

                        </select>

                        <label class="@(string.IsNullOrEmpty(Sort) || Sort == "-1" ? null : "stay")">Order Results</label>

                    </fieldset>

                    <div class="button-holder">

                        <button @onclick:preventDefault="true" @onclick='() => Filter()'>
                            Get Comments
                        </button>

                    </div>

                </div>

            </div>

            @if (Component.TaleComments.Comments != null && Component.TaleComments.Comments.Count > 0)
            {

                <div class="comments-container">

                    @foreach (var comment in Component.TaleComments.Comments)
                    {
                        <div class="comment">

                            <div class="comment-image">
                                <a href="#" @onclick:preventDefault="true" @onclick='() => AddComponent(new ComponentParameters()
                                                    { ComponentType = ComponentTypes.UserProfile, Id = comment.CommentatorId})'>
                                    <img src="@comment.CommentatorDisplayPhotoToString" />
                                </a>
                            </div>

                            <div class="comment-content">

                                <div class="user-details">
                                    <h1>
                                        <a class="at" href="#" @onclick:preventDefault="true" @onclick='() => AddComponent(new ComponentParameters()
                                                    { ComponentType = ComponentTypes.UserProfile, Id = comment.CommentatorId})'>
                                            @comment.CommentatorUsername
                                        </a>
                                    </h1>
                                    <p>
                                        @comment.DateToString
                                    </p>
                                </div>

                                <p class="comment-details">
                                    <div class="richtext">
                                        @(((MarkupString)comment.DetailsDecoded).Sanitize())
                                    </div>
                                </p>

                                <div class="comment-links">
                                    <div class="left-comment-links">
                                        @if (comment.MyRatingsToString != null)
                                        {
                                            <a class="icon love" href="#" @onclick:preventDefault="true" @onclick='() => SetInfo(comment.MyRatingsToString)'>
                                                <span>@comment.Likes</span>
                                            </a>
                                            <a class="icon hate" href="#" @onclick:preventDefault="true" @onclick='() => SetInfo(comment.MyRatingsToString)'>
                                                <span>@comment.Hates</span>
                                            </a>
                                        }
                                        else
                                        {
                                            <a class="icon love" href="#" @onclick:preventDefault="true" @onclick='() => Rate(comment, RateTypes.Like)'>
                                                <span>@comment.Likes</span>
                                            </a>
                                            <a class="icon hate" href="#" @onclick:preventDefault="true" @onclick='() => Rate(comment, RateTypes.Hate)'>
                                                <span>@comment.Hates</span>
                                            </a>
                                        }

                                    </div>
                                    <div class="right-comment-links">

                                        <a class="icon reply" href="#" @onclick:preventDefault="true" @onclick='() => AddComponent(new ComponentParameters()
                                                    { ComponentType = ComponentTypes.CreateTaleResponse, TaleFocusComment = comment})'>
                                        </a>

                                        @if (comment.HasFlagged)
                                        {
                                            <a class="icon flag" href="#" @onclick:preventDefault="true" @onclick='() => SetInfo("You have already flagged this comment")'>
                                            </a>

                                        }
                                        else
                                        {
                                            <a class="icon flag" href="#" @onclick:preventDefault="true" @onclick='() => AddComponent(new ComponentParameters()
                                                    { ComponentType = ComponentTypes.FlagTaleComment, TaleComment = comment})'>
                                            </a>
                                        }

                                        @if (comment.ResponsesCount > 0)
                                        {
                                            <a href="#" @onclick:preventDefault="true" @onclick='() => AddComponent(new ComponentParameters()
                                                    { ComponentType = ComponentTypes.TaleResponses, TaleComment = comment, TaleRecursiveComments = Component.TaleRecursiveComments})'>
                                                <span>@comment.ResponsesCount</span>  Replies
                                            </a>
                                        }
                                        else
                                        {
                                            <a class="disabled" href="#">
                                                <span>@comment.ResponsesCount</span>  Replies
                                            </a>
                                        }

                                    </div>

                                </div>

                            </div>

                        </div>
                    }

                </div>

                <div class="navigation-container">

                    <div class="navigation-links">

                        @if (Component.TaleComments.More)
                        {
                            <a href="#" class="more" @onclick:preventDefault="true" @onclick='() => LoadMore()'></a>
                        }
                        else
                        {
                            <a href="#" class="more disabled" @onclick:preventDefault="true"> </a>
                        }

                    </div>

                </div>

            }
            else
            {
                <div class="no-content">

                    <ErrorGif />

                    <h3>
                        No Result!
                    </h3>

                    @if (Component.TaleComments.Keyword != null)
                    {
                        <p>
                            It appears no comment matches your keywords.
                        </p>
                        <p>
                            Try searching again with more specific keywords. Note that we do not search common words
                            like "is", "are", "them", etc.
                        </p>

                    }
                    else if (Component.TaleComments.Username != null)
                    {
                        <p>
                            It appears the user: @Component.TaleComments.Username has not commented on this tale.
                        </p>
                        <p>
                            Only top level comments - not responses to the comments - were searched.
                        </p>

                    }
                    else
                    {
                        <p>
                            No comment found!
                        </p>
                    }
                    <p>
                        It appears there are currently no comments for this tale.
                    </p>

                </div>

            }

        </div>

    </div>

}
else
{
    <ErrorComponent Message=@Component.ErrorMessage
                    Type="tale comments" />
}


@code {

    [Parameter]
    public ComponentParameters Component { get; set; } = default!;

    bool IsShowFilter { get; set; } = false;


    string? Sort { get; set; } = null;

    string? Username { get; set; } = null;

    private string? Keyword { get; set; } = null;


    protected void SortClicked(ChangeEventArgs e)
    {
        Sort = e.Value == null ? null : e.Value.ToString();
    }

    private async Task Rate(TaleCommentSummary comment, RateTypes rate)
    {

        if (!await authenticate.CheckJwtTokenAsync())
        {
            await OnAddComponent.InvokeAsync(new ComponentParameters() { ComponentType = ComponentTypes.LoginUser });

            return;
        }

        RateTaleCommentRequest formData = new()
            {
                TaleId = comment.TaleId,
                CommentId = comment.Id,
                RateType = rate
            };

        var result = await rateComment.PatchAsync("tales/rate/comment", formData, CancelToken);

        if (result.IsFailure)
        {
            await SetInfo("Error: " + result.Error ?? "Unknown server error");

            return;
        }
        else
        {

            comment.MyRatings = rate;

            if (rate == RateTypes.Like)
            {
                comment.Likes = result.Value.Counts;

                await SetInfo("You liked a comment");

            }
            else
            {
                comment.Hates = result.Value.Counts;

                await SetInfo("You hated a comment");

            }

        }
    }

    [Parameter]
    public EventCallback<ComponentParameters> OnRemoveComponent { get; set; }

    private async void RemoveComponent() =>
       await OnRemoveComponent.InvokeAsync(Component);

    [Parameter]
    public EventCallback OnCloseModal { get; set; }

    private async Task CloseModal() =>
       await OnCloseModal.InvokeAsync();

    bool Window { get; set; } = false;

    [Parameter]
    public EventCallback OnExpandModal { get; set; }

    private async Task ExpandModal()
    {
        Window = !Window;

        await OnExpandModal.InvokeAsync();
    }

    [Parameter]
    public EventCallback<string> OnSetInfo { get; set; }

    private async Task SetInfo(string info) =>
     await OnSetInfo.InvokeAsync(info);

    [Parameter]
    public EventCallback<ComponentParameters> OnAddComponent { get; set; }

    private async Task AddComponent(ComponentParameters component) =>
    await OnAddComponent.InvokeAsync(component);

    public async Task LoadMore()
    {

        var url = $"tales/comments/{Component.TaleComments.TaleId}?";

        if (!string.IsNullOrEmpty(Sort) && Sort != "-1")
        {
            Enum.TryParse(Sort, out SortTypes sort);

            url = url + $"sort={sort}&";
        }

        if (!string.IsNullOrEmpty(Username))
        {
            url = url + $"username={Username}&";
        }

        if (!string.IsNullOrEmpty(Keyword))
        {
            url = url + $"keyword={Keyword}&";
        }

        Component.TaleComments.Pointer++;

        url = url + $"pointer={Component.TaleComments.Pointer}&size=5";

        Component.Url = url;

        Component.Reload = true;

        Component.Append = true;

        await OnAddComponent.InvokeAsync(Component);

        IsShowFilter = false;
    }

    public async Task Filter()
    {

        var url = $"tales/comments/{Component.Id}?";

        if (!string.IsNullOrEmpty(Sort) && Sort != "-1")
        {
            Enum.TryParse(Sort, out SortTypes sort);

            url = url + $"sort={sort}&";
        }

        if (!string.IsNullOrEmpty(Username))
        {
            url = url + $"username={Username}&";
        }

        if (!string.IsNullOrEmpty(Keyword))
        {
            url = url + $"keyword={Keyword}&";
        }

        url = url + "pointer=0&size=5";

        Component.Url = url;

        Component.Reload = true;

        Component.Append = false;

        await OnAddComponent.InvokeAsync(Component);

        IsShowFilter = false;

    }

}
